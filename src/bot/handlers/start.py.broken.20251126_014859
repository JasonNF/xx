"""å¼€å§‹å’ŒåŸºç¡€å‘½ä»¤å¤„ç†å™¨"""
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CommandHandler, CallbackQueryHandler

from bot.models import get_db
from bot.services.player_service import PlayerService
from bot.services.spirit_root_service import SpiritRootService
from bot.config import settings


async def detect_spirit_root_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """å¤„ç† /æ£€æµ‹çµæ ¹ å‘½ä»¤ - å¼€å§‹æ¸¸æˆ"""
    user = update.effective_user

    async with get_db() as db:
        player, is_new = await PlayerService.get_or_create_player(
            db,
            telegram_id=user.id,
            username=user.username,
            first_name=user.first_name
        )

        if is_new:
            # æ–°ç©å®¶ - çµæ ¹æ£€æµ‹æˆåŠŸ
            # è·å–çµæ ¹ä¿¡æ¯
            spirit_root = player.spirit_root
            if spirit_root:
                spirit_root_desc = SpiritRootService.get_root_description(spirit_root)
                spirit_root_comment = SpiritRootService.get_root_comment(spirit_root)
            else:
                spirit_root_desc = "æœªçŸ¥ï¼ˆæ£€æµ‹å¤±è´¥ï¼‰"
                spirit_root_comment = ""

            welcome_text = f"""
âœ¨ çµæ ¹æ£€æµ‹å®Œæˆï¼

æ­å–œä½ ï¼Œ{player.nickname}ï¼ä½ æ‹¥æœ‰ä¿®ä»™èµ„è´¨ï¼

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ é“å·ï¼š{player.nickname}
ğŸŒˆ çµæ ¹ï¼š{spirit_root_desc}
ğŸ’ çº¯åº¦ï¼š{spirit_root.purity}%
âš¡ ä¿®ç‚¼é€Ÿåº¦ï¼š{spirit_root.cultivation_speed_multiplier:.2f}x
ğŸŒŸ åˆå§‹å¢ƒç•Œï¼š{player.full_realm_name}
ğŸ’ åˆå§‹çµçŸ³ï¼š{player.spirit_stones:,}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{spirit_root_comment}

ğŸ æ–°æ‰‹ç¦åˆ©å·²å‘æ”¾ï¼

ğŸ“– ä½ çš„ä¿®ä»™ä¹‹æ—…å°±æ­¤å¼€å§‹...

ğŸ’¡ å¿«é€Ÿå¼€å§‹ï¼š
ğŸ§˜ /ä¿®ç‚¼ - å¼€å§‹ä¿®ç‚¼æå‡å¢ƒç•Œ
âš”ï¸ /å†ç»ƒ - å¤–å‡ºå†ç»ƒè·å–èµ„æº
ğŸ“Š /çŠ¶æ€ - æŸ¥çœ‹è¯¦ç»†è§’è‰²ä¿¡æ¯
ğŸ“– /å¸®åŠ© - æŸ¥çœ‹å®Œæ•´æ¸¸æˆæŒ‡å—
"""
        else:
            # è€ç©å®¶ - æ˜¾ç¤ºå½“å‰çŠ¶æ€
            spirit_root = player.spirit_root
            if spirit_root:
                spirit_root_desc = SpiritRootService.get_root_description(spirit_root)
                spirit_root_line = f"ğŸŒˆ çµæ ¹ï¼š{spirit_root_desc}\n"
            else:
                spirit_root_line = ""

            welcome_text = f"""
ğŸ”® çµæ ¹å…±é¸£...

{player.nickname}ï¼Œä½ å·²è¸å…¥ä¿®ä»™ä¹‹è·¯

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
{spirit_root_line}ğŸŒŸ å½“å‰å¢ƒç•Œï¼š{player.full_realm_name}
âš¡ æˆ˜åŠ›ï¼š{player.combat_power}
ğŸ’ çµçŸ³ï¼š{player.spirit_stones:,}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“– ä½¿ç”¨ /å¸®åŠ© æŸ¥çœ‹æ‰€æœ‰å‘½ä»¤
ğŸ“Š ä½¿ç”¨ /çŠ¶æ€ æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
"""

        # åˆ›å»ºå¿«æ·èœå•
        keyboard = [
            [
                InlineKeyboardButton("ğŸ“Š è§’è‰²çŠ¶æ€", callback_data="status"),
                InlineKeyboardButton("ğŸ§˜ å¼€å§‹ä¿®ç‚¼", callback_data="cultivate"),
            ],
            [
                InlineKeyboardButton("âš”ï¸ æˆ˜æ–—", callback_data="battle"),
                InlineKeyboardButton("ğŸª å•†åº—", callback_data="shop"),
            ],
            [
                InlineKeyboardButton("ğŸ›ï¸ å®—é—¨", callback_data="sect"),
                InlineKeyboardButton("ğŸ“– å¸®åŠ©", callback_data="help"),
            ],
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await send_and_delete(update.message, 
            welcome_text,
            parse_mode="Markdown"
        )


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """å¤„ç† /å¸®åŠ© å‘½ä»¤"""
    help_text = f"""
ğŸ“– **{settings.GAME_NAME} - æ¸¸æˆæŒ‡å—**

**ğŸ® åŸºç¡€å‘½ä»¤**
/æ£€æµ‹çµæ ¹ - å¼€å§‹æ¸¸æˆ/æŸ¥çœ‹è§’è‰²
/çŠ¶æ€ - æŸ¥çœ‹è¯¦ç»†è§’è‰²çŠ¶æ€
/æ”¹å <æ–°é“å·> - ä¿®æ”¹é“å·ï¼ˆç»ˆç”Ÿä¸€æ¬¡ï¼Œ10ä¸‡çµçŸ³ï¼‰
/æ”¹åçŠ¶æ€ - æŸ¥çœ‹æ”¹åçŠ¶æ€
/å¸®åŠ© - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

**ğŸ§˜ ä¿®ç‚¼ç³»ç»Ÿ**
/ä¿®ç‚¼ [å°æ—¶] - å¼€å§‹ä¿®ç‚¼
/ç»“ç®— - å®Œæˆä¿®ç‚¼æ”¶å–ä¿®ä¸º
/å–æ¶ˆ - å–æ¶ˆå½“å‰ä¿®ç‚¼
/çªç ´ - å°è¯•çªç ´å¢ƒç•Œ
/çµæ ¹ - æ£€æµ‹çµæ ¹

**âš”ï¸ æˆ˜æ–—ç³»ç»Ÿ**
/æˆ˜æ–— [æ€ªç‰©å] - æŒ‘æˆ˜æ€ªç‰©(PVE)
/åˆ‡ç£‹ - æŒ‘æˆ˜å…¶ä»–ç©å®¶(å›å¤ä½¿ç”¨)
/æŠ€èƒ½ - æŸ¥çœ‹å·²å­¦æŠ€èƒ½
/å­¦ä¹  [æŠ€èƒ½å] - å­¦ä¹ æ–°æŠ€èƒ½
/å‡çº§ [æŠ€èƒ½å] - å‡çº§æŠ€èƒ½
/æ–½æ³• [æŠ€èƒ½å] - æµ‹è¯•æŠ€èƒ½

**ğŸ›ï¸ ç§˜å¢ƒç³»ç»Ÿ**
/ç§˜å¢ƒ - æŸ¥çœ‹å¯ç”¨ç§˜å¢ƒ
/æ¢ç´¢ [ç§˜å¢ƒå] - è¿›å…¥ç§˜å¢ƒæ¢ç´¢

**ğŸ“‹ ä»»åŠ¡ç³»ç»Ÿ**
/ä»»åŠ¡ [ç±»å‹] - æŸ¥çœ‹ä»»åŠ¡åˆ—è¡¨
/æ¥å– [ä»»åŠ¡ID] - æ¥å–ä»»åŠ¡
/å®Œæˆ [ä»»åŠ¡ID] - å®Œæˆä»»åŠ¡

**ğŸ’° ç§¯åˆ†å•†åŸ**
/ç§¯åˆ†å•†åŸ æˆ– /å•†åŸ - æµè§ˆå•†åŸå•†å“
/æˆ‘çš„ç§¯åˆ† - æŸ¥çœ‹ç§¯åˆ†ä½™é¢å’Œè®°å½•

**ğŸ’¡ æç¤º**
â€¢ ä¿®ç‚¼æ˜¯è·å¾—ä¿®ä¸ºçš„ä¸»è¦æ–¹å¼
â€¢ æ¢ç´¢ç§˜å¢ƒè·å¾—ç¨€æœ‰ç‰©å“
â€¢ å­¦ä¹ æŠ€èƒ½æå‡æˆ˜æ–—åŠ›
â€¢ æˆ˜æ–—å‰è¯·ç¡®ä¿ç”Ÿå‘½å€¼å……è¶³
â€¢ ç§¯åˆ†å¯é€šè¿‡ç­¾åˆ°ã€ä»»åŠ¡ã€PVPç­‰é€”å¾„è·å¾—
"""

    await send_and_delete(update.message, help_text, parse_mode="Markdown")


async def status_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """å¤„ç† /çŠ¶æ€ å‘½ä»¤ - æ˜¾ç¤ºç©å®¶å½“å‰çŠ¶æ€"""
    user = update.effective_user

    async with get_db() as db:
        result = await db.execute(
            select(Player)
            .where(Player.telegram_id == user.id)
            .options(selectinload(Player.spirit_root))
        )
        player = result.scalar_one_or_none()

        if not player:
            await send_and_delete(update.message, 
                "âŒ ä½ è¿˜æ²¡æœ‰å¼€å§‹ä¿®ä»™ä¹‹æ—…
"
                "è¯·å…ˆä½¿ç”¨ /start å‘½ä»¤æ£€æµ‹çµæ ¹"
            )
            return

        # è®¡ç®—ä¿®ä¸ºè¿›åº¦
        progress = (player.cultivation_exp / player.next_realm_exp) * 100
        progress_bar = "â–ˆ" * int(progress / 10) + "â–‘" * (10 - int(progress / 10))

        status_text = f"""
ğŸ‘¤ **{player.nickname}**

ğŸŒŸ **å¢ƒç•Œ**: {player.full_realm_name}
ğŸ“Š **ä¿®ä¸º**: {player.cultivation_exp:,}/{player.next_realm_exp:,}
â–° {progress_bar} {progress:.1f}%

ğŸ’š **ç”Ÿå‘½**: {player.hp}/{player.max_hp}
ğŸ’™ **çµåŠ›**: {player.spiritual_power}/{player.max_spiritual_power}

âš”ï¸ **ï¿½å‡»å‡»**: {player.attack}
ğŸ›¡ï¸ **é˜²å¾¡**: {player.defense}
âš¡ **é€Ÿåº¦**: {player.speed}
ğŸ’¥ **æš´å‡»ç‡**: {player.crit_rate * 100:.1f}%
ğŸ’¥ **æš´å‡»ä¼¤å®³**: {player.crit_damage:.1f}x

ğŸ§  **æ‚Ÿæ€§**: {player.comprehension}
ğŸ’ **çµçŸ³**: {player.spirit_stones:,}

â³ **å¹´é¾„/å¯¿å…ƒ**: {player.age}/{player.lifespan}
"""

        # å¦‚æœæœ‰çµæ ¹ä¿¡æ¯
        if player.spirit_root:
            from bot.services.spirit_root_service import SpiritRootService
            spirit_root_desc = SpiritRootService.get_root_description(player.spirit_root)
            status_text += f"
ğŸŒˆ **çµæ ¹**: {spirit_root_desc}
"
            status_text += f"ğŸ’ **çº¯åº¦**: {player.spirit_root.purity}%
"

        # å¦‚æœæœ‰å®—é—¨
        if player.sect_id:
            status_text += f"
ğŸ›ï¸ **å®—é—¨è´¡çŒ®**: {player.contribution:,}
"

        # å¦‚æœæ˜¯ç»“ä¸¹æœŸä»¥ä¸Šï¼Œæ˜¾ç¤ºé‡‘ä¸¹å“è´¨
        if player.golden_core_quality > 0:
            status_text += f"
âš—ï¸ **é‡‘ä¸¹å“è´¨**: {player.golden_core_quality}å“
"

        await send_and_delete(update.message, status_text, parse_mode="Markdown")


# æ³¨å†Œå¤„ç†å™¨çš„å‡½æ•°
def register_handlers(application):
    """æ³¨å†Œæ‰€æœ‰å¤„ç†å™¨"""
    import logging
    logger = logging.getLogger(__name__)
    logger.info("start.register_handlers è¢«è°ƒç”¨")
    
    application.add_handler(CommandHandler("start", detect_spirit_root_command))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(CommandHandler("info", status_command))
    
    logger.info("âœ… start handlerså·²æ³¨å†Œ: /start, /help, /info")