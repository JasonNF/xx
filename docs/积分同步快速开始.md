# ç§¯åˆ†åŒæ­¥ - å¿«é€Ÿå¼€å§‹æŒ‡å—

## 5åˆ†é’Ÿå¿«é€Ÿé›†æˆ

æœ¬æŒ‡å—å¸®åŠ©ä½ åœ¨5åˆ†é’Ÿå†…å®Œæˆè·¨é¡¹ç›®ç§¯åˆ†åŒæ­¥çš„é›†æˆã€‚

---

## ğŸ“¦ å‰ç½®å‡†å¤‡

1. **è·å–APIå‡­è¯**ï¼š
   - APIå¯†é’¥ï¼ˆX-Api-Keyï¼‰
   - åŒæ­¥å¯†é’¥ï¼ˆSecret Keyï¼‰
   - APIæœåŠ¡åœ°å€

2. **ç¡®è®¤ç½‘ç»œè¿é€š**ï¼š
   - ç¡®ä¿ä½ çš„é¡¹ç›®èƒ½è®¿é—®ç§¯åˆ†åŒæ­¥APIæœåŠ¡

---

## ğŸš€ æ–¹å¼ä¸€ï¼šä½¿ç”¨Python SDKï¼ˆæ¨èï¼‰

### æ­¥éª¤1ï¼šå®‰è£…ä¾èµ–

```bash
pip install requests
```

### æ­¥éª¤2ï¼šå¤åˆ¶SDKæ–‡ä»¶

å°† `credit_sync_client.py` å¤åˆ¶åˆ°ä½ çš„é¡¹ç›®ä¸­ã€‚

### æ­¥éª¤3ï¼šåˆå§‹åŒ–å®¢æˆ·ç«¯

```python
from credit_sync_client import CreditSyncClient

# åˆ›å»ºå®¢æˆ·ç«¯
client = CreditSyncClient(
    base_url="https://api.yourdomain.com",  # APIåœ°å€
    api_key="media-bot-api-key-2024",       # ä½ çš„APIå¯†é’¥
    secret_key="your-secret-key-here",      # åŒæ­¥å¯†é’¥
    source="media_bot"                      # ä½ çš„é¡¹ç›®æ ‡è¯†
)
```

### æ­¥éª¤4ï¼šå¼€å§‹ä½¿ç”¨

```python
# å¢åŠ ç§¯åˆ†
result = client.add_credits(
    telegram_id=123456789,
    amount=100,
    reason="è§‚çœ‹è§†é¢‘å¥–åŠ±",
    reference="video_12345"  # å¯é€‰ï¼Œç”¨äºå»é‡
)

if result.success:
    print(f"âœ… æˆåŠŸï¼ä½™é¢ï¼š{result.balance}")
else:
    print(f"âŒ å¤±è´¥ï¼š{result.message}")

# æŸ¥è¯¢ä½™é¢
balance = client.get_balance(123456789)
print(f"å½“å‰ç§¯åˆ†ï¼š{balance['credits']}")
```

**å®Œæˆï¼** ğŸ‰

---

## ğŸ”§ æ–¹å¼äºŒï¼šç›´æ¥HTTPè¯·æ±‚

### Pythonç¤ºä¾‹

```python
import requests
import time
import hmac
import hashlib

# é…ç½®
API_URL = "https://api.yourdomain.com/api/credits/sync"
API_KEY = "your-api-key"
SECRET = "your-secret-key"
SOURCE = "media_bot"

def generate_token(telegram_id, amount, timestamp):
    """ç”ŸæˆéªŒè¯ä»¤ç‰Œ"""
    message = f"{telegram_id}:{amount}:{SOURCE}:{timestamp}"
    return hmac.new(
        SECRET.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()

def sync_credits(telegram_id, amount, reason):
    """åŒæ­¥ç§¯åˆ†"""
    timestamp = int(time.time())
    token = generate_token(telegram_id, amount, timestamp)

    response = requests.post(
        API_URL,
        json={
            "telegram_id": telegram_id,
            "amount": amount,
            "source": SOURCE,
            "reason": reason,
            "timestamp": timestamp,
            "token": token
        },
        headers={"X-Api-Key": API_KEY}
    )

    return response.json()

# ä½¿ç”¨
result = sync_credits(123456789, 100, "æµ‹è¯•å¥–åŠ±")
print(result)
```

### JavaScript/Node.jsç¤ºä¾‹

```javascript
const crypto = require('crypto');
const axios = require('axios');

const API_URL = 'https://api.yourdomain.com/api/credits/sync';
const API_KEY = 'your-api-key';
const SECRET = 'your-secret-key';
const SOURCE = 'media_bot';

function generateToken(telegramId, amount, timestamp) {
  const message = `${telegramId}:${amount}:${SOURCE}:${timestamp}`;
  return crypto
    .createHmac('sha256', SECRET)
    .update(message)
    .digest('hex');
}

async function syncCredits(telegramId, amount, reason) {
  const timestamp = Math.floor(Date.now() / 1000);
  const token = generateToken(telegramId, amount, timestamp);

  try {
    const response = await axios.post(
      API_URL,
      {
        telegram_id: telegramId,
        amount: amount,
        source: SOURCE,
        reason: reason,
        timestamp: timestamp,
        token: token
      },
      {
        headers: { 'X-Api-Key': API_KEY }
      }
    );

    return response.data;
  } catch (error) {
    console.error('Error:', error.response?.data || error.message);
    return null;
  }
}

// ä½¿ç”¨
(async () => {
  const result = await syncCredits(123456789, 100, 'æµ‹è¯•å¥–åŠ±');
  console.log(result);
})();
```

---

## ğŸ’¡ å¸¸è§ä½¿ç”¨åœºæ™¯

### åœºæ™¯1ï¼šç”¨æˆ·å®Œæˆä»»åŠ¡è·å¾—ç§¯åˆ†

```python
# ç”¨æˆ·åœ¨åª’ä½“Botè§‚çœ‹äº†è§†é¢‘
video_id = "video_12345"
telegram_id = user.telegram_id

result = client.add_credits(
    telegram_id=telegram_id,
    amount=50,
    reason="è§‚çœ‹è§†é¢‘ã€Šä¿®ä»™ä¹‹è·¯ã€‹",
    reference=f"video_{video_id}"  # é˜²æ­¢é‡å¤å¥–åŠ±
)
```

### åœºæ™¯2ï¼šç”¨æˆ·åœ¨å•†åŸæ¶ˆè´¹ç§¯åˆ†

```python
# ç”¨æˆ·åœ¨åª’ä½“Botå•†åŸè´­ä¹°äº†VIP
order_id = "order_67890"

result = client.deduct_credits(
    telegram_id=telegram_id,
    amount=500,
    reason="è´­ä¹°VIPä¼šå‘˜",
    reference=f"order_{order_id}"
)

if result.success:
    # å‘æ”¾VIPæƒç›Š
    grant_vip_privilege(telegram_id)
else:
    # ç§¯åˆ†ä¸è¶³ï¼Œæç¤ºç”¨æˆ·
    notify_user("ç§¯åˆ†ä¸è¶³ï¼Œè¯·å…ˆèµšå–ç§¯åˆ†")
```

### åœºæ™¯3ï¼šæ‰¹é‡å‘æ”¾æ´»åŠ¨å¥–åŠ±

```python
# æ´»åŠ¨ç»“æŸï¼Œæ‰¹é‡å‘æ”¾å¥–åŠ±
winners = [
    {"telegram_id": 123456, "amount": 1000, "reason": "æ´»åŠ¨ç¬¬1å"},
    {"telegram_id": 789012, "amount": 500, "reason": "æ´»åŠ¨ç¬¬2å"},
    {"telegram_id": 345678, "amount": 200, "reason": "æ´»åŠ¨ç¬¬3å"}
]

result = client.batch_sync(winners)
print(f"æˆåŠŸ: {result.data['success']}, å¤±è´¥: {result.data['failed']}")
```

### åœºæ™¯4ï¼šæŸ¥è¯¢ç”¨æˆ·ç§¯åˆ†

```python
# åœ¨ç”¨æˆ·æ‰“å¼€å•†åŸå‰ï¼Œå…ˆæŸ¥è¯¢ä½™é¢
balance = client.get_balance(telegram_id)

if balance:
    credits = balance['credits']
    print(f"ç”¨æˆ· {balance['nickname']} å½“å‰æœ‰ {credits} ç§¯åˆ†")

    # æ˜¾ç¤ºå¯è´­ä¹°çš„å•†å“
    show_available_items(credits)
else:
    print("ç”¨æˆ·æœªæ³¨å†Œ")
```

---

## âš ï¸ é‡è¦æç¤º

### 1. é˜²æ­¢é‡å¤å¥–åŠ±

**åŠ¡å¿…ä½¿ç”¨** `external_reference` å­—æ®µï¼š

```python
# âœ… æ­£ç¡® - ä½¿ç”¨å”¯ä¸€å¼•ç”¨ID
client.add_credits(
    telegram_id=123456789,
    amount=100,
    reason="å®Œæˆä»»åŠ¡",
    reference=f"task_{task_id}_{date}"  # å”¯ä¸€æ ‡è¯†
)

# âŒ é”™è¯¯ - æ²¡æœ‰å¼•ç”¨IDï¼Œå¯èƒ½é‡å¤å¥–åŠ±
client.add_credits(
    telegram_id=123456789,
    amount=100,
    reason="å®Œæˆä»»åŠ¡"
    # ç¼ºå°‘referenceï¼Œç”¨æˆ·å¯èƒ½é‡å¤é¢†å–
)
```

### 2. é”™è¯¯å¤„ç†

**å§‹ç»ˆæ£€æŸ¥è¿”å›ç»“æœ**ï¼š

```python
result = client.add_credits(...)

if result.success:
    # æˆåŠŸå¤„ç†
    update_user_status(telegram_id, "credited")
else:
    # å¤±è´¥å¤„ç†
    log_error(f"ç§¯åˆ†åŒæ­¥å¤±è´¥: {result.message}")
    notify_admin(f"ç”¨æˆ· {telegram_id} ç§¯åˆ†åŒæ­¥å¤±è´¥")
```

### 3. ä½™é¢æ£€æŸ¥

**æ‰£é™¤å‰å…ˆæŸ¥è¯¢ä½™é¢**ï¼š

```python
# æŸ¥è¯¢ä½™é¢
balance_info = client.get_balance(telegram_id)

if balance_info and balance_info['credits'] >= required_amount:
    # ä½™é¢å……è¶³ï¼Œæ‰§è¡Œæ‰£é™¤
    result = client.deduct_credits(telegram_id, required_amount, "è´­ä¹°å•†å“")
else:
    # ä½™é¢ä¸è¶³
    notify_user("ç§¯åˆ†ä¸è¶³")
```

---

## ğŸ” æµ‹è¯•

### æµ‹è¯•è„šæœ¬

```python
# test_credit_sync.py

from credit_sync_client import CreditSyncClient

client = CreditSyncClient(
    base_url="https://api.yourdomain.com",
    api_key="your-api-key",
    secret_key="your-secret-key",
    source="test"
)

def test_sync():
    """æµ‹è¯•ç§¯åˆ†åŒæ­¥"""
    test_user = 123456789

    print("=== æµ‹è¯•1ï¼šå¢åŠ ç§¯åˆ† ===")
    result = client.add_credits(test_user, 100, "æµ‹è¯•")
    print(f"ç»“æœ: {result.success}")
    print(f"æ¶ˆæ¯: {result.message}")

    print("\n=== æµ‹è¯•2ï¼šæŸ¥è¯¢ä½™é¢ ===")
    balance = client.get_balance(test_user)
    print(f"ä½™é¢: {balance['credits'] if balance else 'æŸ¥è¯¢å¤±è´¥'}")

    print("\n=== æµ‹è¯•3ï¼šæŸ¥è¯¢è®°å½• ===")
    records = client.get_records(test_user, limit=5)
    if records:
        for r in records['records']:
            print(f"  {r['change']:+d} - {r['reason']}")

    print("\n=== æµ‹è¯•4ï¼šæ‰£é™¤ç§¯åˆ† ===")
    result = client.deduct_credits(test_user, 50, "æµ‹è¯•æ¶ˆè´¹")
    print(f"ç»“æœ: {result.success}")

if __name__ == "__main__":
    test_sync()
```

è¿è¡Œæµ‹è¯•ï¼š
```bash
python test_credit_sync.py
```

---

## ğŸ“š ä¸‹ä¸€æ­¥

- ğŸ“– æŸ¥çœ‹ [å®Œæ•´APIæ–‡æ¡£](./ç§¯åˆ†åŒæ­¥APIæ–‡æ¡£.md)
- ğŸš€ æŸ¥çœ‹ [éƒ¨ç½²æŒ‡å—](./ç§¯åˆ†åŒæ­¥éƒ¨ç½²æŒ‡å—.md)
- ğŸ’¬ é‡åˆ°é—®é¢˜ï¼ŸæŸ¥çœ‹ [å¸¸è§é—®é¢˜](./ç§¯åˆ†åŒæ­¥APIæ–‡æ¡£.md#å¸¸è§é—®é¢˜)

---

## ğŸ†˜ è·å–å¸®åŠ©

**é—®é¢˜æ’æŸ¥æ¸…å•**:
1. âœ… APIåœ°å€æ˜¯å¦æ­£ç¡®ï¼Ÿ
2. âœ… APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆï¼Ÿ
3. âœ… åŒæ­¥å¯†é’¥æ˜¯å¦åŒ¹é…ï¼Ÿ
4. âœ… ç½‘ç»œæ˜¯å¦è¿é€šï¼Ÿ
5. âœ… æ—¶é—´æˆ³æ˜¯å¦æ­£ç¡®ï¼Ÿ

**è”ç³»æ–¹å¼**:
- æŠ€æœ¯æ”¯æŒï¼šè”ç³»ç³»ç»Ÿç®¡ç†å‘˜
- é”™è¯¯æŠ¥å‘Šï¼šæäº¤Issue

---

**æœ€åæ›´æ–°**: 2024-01-XX
