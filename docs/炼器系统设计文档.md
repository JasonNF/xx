# 炼器系统设计文档

## 📋 系统概述

炼器系统是修仙游戏的核心玩法之一,玩家可以通过炼器技能将材料炼制成各种法宝装备。

### 核心特点
- **技能成长**: 炼器等级影响成功率和可炼制的法宝品质
- **材料收集**: 需要各种矿石、材料作为炼器原料
- **时间投入**: 不同品质的法宝需要不同的炼制时间
- **成功率机制**: 基于炼器等级、悟性、洞府加成等因素
- **装备强化**: 可对已有装备进行强化提升属性

---

## 🎯 系统功能

### 1. 炼器技能

#### 等级系统
- **初始等级**: Lv.1
- **升级方式**: 炼器获得经验值
- **经验获取**:
  - 成功炼器: 100 + 配方等级 × 20 经验
  - 失败炼器: 20 经验
- **升级公式**: 下一级经验 = 当前所需 × 1.5

#### 等级加成
- 炼器等级每高于配方要求1级: +5% 成功率
- 悟性: 每点+1% 成功率
- 洞府炼器房: 额外加成(由洞府系统提供)

### 2. 炼器配方

#### 配方结构
```json
{
  "name": "青钢剑",
  "description": "以寒铁矿石炼制的初级飞剑",
  "result_item_id": 1001,
  "required_refinery_level": 1,
  "base_success_rate": 0.80,
  "materials": [
    {"item_id": 2001, "quantity": 5},  // 寒铁矿石x5
    {"item_id": 2002, "quantity": 3}   // 妖兽皮x3
  ],
  "spiritual_power_cost": 50,
  "duration_hours": 2
}
```

#### 配方分类

**武器类**:
- 炼气期: 青钢剑、赤铜刀、紫电剑、玄冰刺、烈焰刀、碧波剑
- 筑基期: 青罡剑、赤炎剑
- 结丹期: 紫霄剑

**护甲类**:
- 炼气期: 青木甲、玄铁甲、流云衫
- 筑基期: 金刚甲

**饰品类**:
- 炼气期: 聚灵环、护心镜、疾行靴

**特殊法宝**:
- 结丹期: 太阳真火炉(炼丹辅助)

### 3. 炼器材料

#### 材料类型

**基础矿石** (炼气期):
- 寒铁矿石、赤铜矿、寒铁、玄铁、精钢
- 价格: 10-150灵石

**属性矿石** (炼气期):
- 紫晶石(雷)、玄冰玉(冰)、炎晶(火)、水云石(水)
- 价格: 60-100灵石

**妖兽材料**:
- 妖兽皮、雷兽筋、火蛟鳞、灵兽毛、兽筋
- 价格: 8-150灵石

**高级材料** (筑基期):
- 青罡石、精金、金刚石
- 妖丹(风/火属性)
- 价格: 300-900灵石

**顶级材料** (结丹期):
- 紫霄石、天雷铁、太阳真金、地心火铜
- 金丹(雷/火属性)
- 价格: 2000-12000灵石

#### 材料获取途径
1. **商店购买**: 基础材料可在NPC商店购买
2. **战斗掉落**: 击杀妖兽获得特殊材料
3. **秘境探索**: 秘境中有概率获得稀有材料
4. **玩家交易**: 通过市场与其他玩家交易

### 4. 炼器流程

#### 开始炼制
```
1. 检查条件:
   - 炼器等级是否满足
   - 灵力是否充足
   - 材料是否齐全
   - 是否正在修炼/战斗
   
2. 消耗资源:
   - 扣除所需材料
   - 消耗灵力
   
3. 开始炼制:
   - 设置炼制状态
   - 记录开始和结束时间
```

#### 完成炼制
```
1. 检查是否完成:
   - 当前时间 >= 结束时间
   
2. 计算成功率:
   - 基础成功率
   - + (炼器等级 - 配方要求) × 5%
   - + 悟性 × 1%
   - + 洞府加成
   - 最终成功率: 10%-95%
   
3. 判定结果:
   - 成功: 获得法宝 + 经验
   - 失败: 仅获得少量经验
   
4. 更新数据:
   - 增加经验值
   - 检查是否升级
   - 记录炼器历史
```

### 5. 装备强化

#### 强化机制
- **强化等级**: 0 → +12
- **成功率**: 100% - (强化等级 × 5%)
  - +0 → +1: 100%
  - +5 → +6: 75%
  - +11 → +12: 45%

#### 强化效果
每次强化成功:
- 攻击力: +5
- 防御力: +3
- 生命值: +10

#### 强化限制
- 必须卸下装备才能强化
- 强化失败不掉级,但材料消耗
- 最高+12级

---

## 📊 数值平衡

### 成功率设计

| 配方品质 | 基础成功率 | 炼器等级要求 | 材料价值 |
|---------|-----------|-------------|---------|
| 炼气前期 | 75%-85% | Lv.1-3 | 50-100灵石 |
| 炼气中期 | 60%-70% | Lv.4-6 | 200-500灵石 |
| 炼气后期 | 50%-60% | Lv.7-10 | 500-1500灵石 |
| 筑基期 | 40%-45% | Lv.10-12 | 3000-8000灵石 |
| 结丹期 | 25%-30% | Lv.15-18 | 20000-50000灵石 |

### 时间投入

| 配方品质 | 炼制时间 | 灵力消耗 |
|---------|---------|---------|
| 炼气前期 | 1-3小时 | 40-80 |
| 炼气中期 | 3-6小时 | 100-180 |
| 炼气后期 | 5-9小时 | 180-250 |
| 筑基期 | 12-15小时 | 350-400 |
| 结丹期 | 24-36小时 | 600-800 |

### 经济平衡

**投入产出比**:
- 炼气前期法宝: 成本50-100灵石 → 价值150-300灵石
- 炼气中期法宝: 成本300-800灵石 → 价值1000-2500灵石
- 筑基期法宝: 成本3000-8000灵石 → 价值10000-25000灵石

**炼器师收益**:
- 成功率提升可显著降低成本
- 高等级炼器师可承接其他玩家订单
- 稀有配方可卖出高价

---

## 🗄️ 数据库设计

### 核心表

#### refinery_recipes (炼器配方表)
```sql
CREATE TABLE refinery_recipes (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,           -- 配方名称
    description TEXT NOT NULL,                    -- 描述
    result_item_id INTEGER NOT NULL,              -- 产出物品ID
    required_refinery_level INTEGER DEFAULT 1,    -- 要求炼器等级
    base_success_rate FLOAT DEFAULT 0.5,          -- 基础成功率
    materials TEXT NOT NULL,                      -- 材料JSON
    spiritual_power_cost INTEGER DEFAULT 100,     -- 灵力消耗
    duration_hours INTEGER DEFAULT 2,             -- 炼制时长
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### player_refinery (玩家炼器数据表)
```sql
CREATE TABLE player_refinery (
    id INTEGER PRIMARY KEY,
    player_id INTEGER NOT NULL,                   -- 玩家ID
    refinery_level INTEGER DEFAULT 1,             -- 炼器等级
    refinery_exp INTEGER DEFAULT 0,               -- 炼器经验
    next_level_exp INTEGER DEFAULT 1000,          -- 升级所需经验
    is_refining BOOLEAN DEFAULT FALSE,            -- 是否正在炼制
    refining_recipe_id INTEGER,                   -- 当前炼制配方
    refining_start_time DATETIME,                 -- 开始时间
    refining_end_time DATETIME,                   -- 结束时间
    total_refines INTEGER DEFAULT 0,              -- 总炼制次数
    success_count INTEGER DEFAULT 0,              -- 成功次数
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### refinery_records (炼器历史记录表)
```sql
CREATE TABLE refinery_records (
    id INTEGER PRIMARY KEY,
    player_id INTEGER NOT NULL,
    recipe_id INTEGER NOT NULL,
    is_success BOOLEAN NOT NULL,                  -- 是否成功
    item_quality INTEGER DEFAULT 0,               -- 物品品质(0-100)
    exp_gained INTEGER DEFAULT 0,                 -- 获得经验
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

#### item_enhancements (装备强化表)
```sql
CREATE TABLE item_enhancements (
    id INTEGER PRIMARY KEY,
    inventory_id INTEGER UNIQUE NOT NULL,         -- 背包物品ID
    enhancement_level INTEGER DEFAULT 0,          -- 强化等级(0-12)
    refining_progress INTEGER DEFAULT 0,          -- 祭炼进度(0-100)
    bonus_attack INTEGER DEFAULT 0,               -- 额外攻击
    bonus_defense INTEGER DEFAULT 0,              -- 额外防御
    bonus_hp INTEGER DEFAULT 0,                   -- 额外生命
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

---

## 🎮 游戏命令

### 基础命令

| 命令 | 功能 | 示例 |
|-----|-----|-----|
| `/炼器` | 查看炼器信息 | `/炼器` |
| `/器方` | 查看炼器配方列表 | `/器方` |
| `/炼制法宝 <名称>` | 开始炼制法宝 | `/炼制法宝 青钢剑` |
| `/炼器结算` | 完成炼制并结算 | `/炼器结算` |
| `/炼器取消` | 取消当前炼制 | `/炼器取消` |

### 命令返回示例

#### /炼器
```
🔨 【炼器信息】

炼器等级：Lv.5
炼器经验：800/1500
成功率：15/20 (75.0%)

🔥 正在炼制中
法宝：紫电剑
剩余时间：2小时30分钟

💡 使用 /炼器结算 完成炼制
💡 使用 /炼器取消 取消炼制
```

#### /器方
```
📜 【炼器配方】

炼器等级：Lv.5
💧 灵力：350/500
━━━━━━━━━━━━━━

✅ **青钢剑**
    以寒铁矿石炼制的初级飞剑，锋利但...
    产出：青钢剑
    成功率：80%
    消耗：50灵力 | 时长：2小时
    材料：寒铁矿石x5, 妖兽皮x3

✅ **紫电剑**
    雷属性飞剑，蕴含微弱雷灵力
    产出：紫电剑
    成功率：65%
    消耗：120灵力 | 时长：4小时
    材料：雷击木x8, 紫晶石x5, 雷兽筋x2

🔒 **烈焰刀**
    火属性宝刀，附带炎爆效果
    产出：烈焰刀
    成功率：55%
    消耗：200灵力 | 时长：6小时
    材料：炎晶x10, 赤金x8, 火蛟鳞x3
    ⚠️ 需要炼器Lv.7

━━━━━━━━━━━━━━
💡 使用 /炼制法宝 <法宝名> 开始炼制
```

#### /炼制法宝 青钢剑
```
🔨 开始炼制 青钢剑，预计2小时后完成

消耗：50灵力
剩余灵力：300/500
```

#### /炼器结算 (成功)
```
🎉 炼制成功！

⚔️ 获得：青钢剑
✨ 品质：75/100

⭐ 经验：+120

🎊 炼器等级提升至 Lv.6！
```

#### /炼器结算 (失败)
```
💥 炼制失败...

⭐ 经验：+20

再接再厉！
```

---

## 🚀 后续扩展

### 短期计划
- [ ] 增加更多配方(元婴期、化神期)
- [ ] 炼器专精系统(武器专精、护甲专精等)
- [ ] 法宝祭炼系统(提升法宝品质)
- [ ] 本命法宝系统(绑定法宝,随修为成长)

### 长期规划
- [ ] 炼器师公会系统
- [ ] 自定义配方研究
- [ ] 法宝附魔系统
- [ ] 套装炼制系统
- [ ] 传承法宝系统

---

## 📝 实现清单

### 已完成 ✅
- [x] 数据模型设计
- [x] 炼器Service层
- [x] 炼器Handler层
- [x] 炼器配方SQL
- [x] 炼器材料SQL
- [x] 系统文档

### 待完成 ⏳
- [ ] 更多配方数据
- [ ] 法宝属性完善
- [ ] 强化系统优化
- [ ] 炼器成就系统
- [ ] 炼器排行榜

---

## 💡 游戏提示

### 新手指南
1. **从基础开始**: 先炼制成功率高的青钢剑、赤铜刀积累经验
2. **材料准备**: 提前囤积常用材料,避免临时采购
3. **灵力管理**: 合理安排炼器时间,避免灵力不足
4. **洞府加成**: 建造炼器房可显著提升成功率

### 进阶技巧
1. **等级优势**: 炼器等级高于配方要求越多,成功率越高
2. **悟性加点**: 悟性不仅影响修炼,也影响炼器成功率
3. **批量炼制**: 同时准备多份材料,可连续炼制
4. **市场经济**: 高等级炼器师可承接订单赚取灵石

---

**文档版本**: v1.0
**最后更新**: 2025-11-25
**维护者**: Claude Code (Sonnet 4.5)
