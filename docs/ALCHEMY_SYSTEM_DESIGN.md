# 炼丹系统设计文档 - 凡人修仙传版本

## 📋 系统概述

炼丹系统是凡人修仙传中的核心玩法之一。玩家通过收集灵药材料,学习丹方,炼制各类丹药来辅助修炼、战斗和突破境界。

---

## 🎯 设计理念

### 核心特点
1. **资源消耗型系统**：需要灵药、灵石、灵力和时间
2. **概率成功机制**：基础成功率 + 炼丹等级加成 + 功法加成
3. **经验成长系统**：通过炼丹提升炼丹等级,解锁更高级丹方
4. **原著丹药还原**：筑基丹、凝金丹、破婴丹等经典丹药

### 平衡性原则
- 低级丹药：材料易得,成功率高,效果一般
- 中级丹药：材料稀有,成功率中等,效果显著
- 高级丹药：材料极稀有,成功率低,效果强大

---

## 💊 丹药分级体系

### 丹药品级

| 品级 | 境界范围 | 成功率范围 | 炼丹等级 | 数量 |
|------|----------|-----------|---------|------|
| **凡品丹药** | 炼气期 | 70-90% | 1-3 | 8种 |
| **灵品丹药** | 炼气后期-筑基期 | 50-70% | 4-7 | 10种 |
| **宝品丹药** | 筑基-金丹期 | 30-50% | 8-12 | 8种 |
| **仙品丹药** | 金丹-元婴期 | 15-30% | 13-18 | 6种 |
| **神品丹药** | 元婴-化神期 | 5-15% | 19+ | 4种 |

**总计**: 36种丹药配方

---

## 🌿 灵药材料体系

### 材料分类

#### 基础灵草（炼气期常见）
1. **青灵草** - 最基础的灵草,用于回春丹等
2. **碧心花** - 恢复灵力的基础材料
3. **紫云芝** - 增强修为的低级灵药
4. **金线藤** - 强化体魄的藤类植物

#### 中级灵药（筑基期稀有）
5. **玉随芝** - 筑基丹主药,300年以上
6. **赤火果** - 火属性灵果,提升火法威力
7. **寒冰莲** - 水属性灵莲,清心凝神
8. **金刚果** - 强化防御的坚硬灵果
9. **九幽草** - 阴属性灵草,解毒排毒

#### 高级灵物（金丹期罕见）
10. **天灵果** - 结丹灵物,千年才结果
11. **紫髓晶** - 元婴期疗伤圣药材料
12. **龙血草** - 传说中妖兽龙血滋养的灵草
13. **凤羽花** - 极阳之物,破婴丹辅药
14. **星月露** - 夜间吸收星月之力的露水

#### 顶级仙药（元婴期传说）
15. **血参精** - 万年血参精华
16. **化神花** - 化神灵物,人界罕见

---

## 📜 丹方配方详细设计

### 一、凡品丹药（8种）

#### 1. 回春丹（基础疗伤）
- **效果**: 恢复500点生命值
- **材料**: 青灵草×3, 碧心花×2
- **炼制要求**: 炼丹等级1
- **成功率**: 90%
- **产出数量**: 1-3颗
- **灵力消耗**: 30
- **炼制时长**: 0.5小时
- **灵石成本**: 500

#### 2. 聚灵丹（基础恢复灵力）
- **效果**: 恢复300点灵力
- **材料**: 碧心花×3, 紫云芝×2
- **炼制要求**: 炼丹等级1
- **成功率**: 90%
- **产出数量**: 1-3颗
- **灵力消耗**: 30
- **炼制时长**: 0.5小时
- **灵石成本**: 400

#### 3. 炼气丹（增加修为）
- **效果**: 获得500点修为经验
- **材料**: 紫云芝×4, 青灵草×3
- **炼制要求**: 炼丹等级1
- **成功率**: 85%
- **产出数量**: 1-2颗
- **灵力消耗**: 40
- **炼制时长**: 1小时
- **灵石成本**: 800

#### 4. 凝气丹（强化灵力上限）
- **效果**: 永久增加20点灵力上限
- **材料**: 碧心花×4, 金线藤×2
- **炼制要求**: 炼丹等级2
- **成功率**: 80%
- **产出数量**: 1颗
- **灵力消耗**: 50
- **炼制时长**: 1小时
- **灵石成本**: 1500

#### 5. 强体丹（增强体魄）
- **效果**: 永久增加30点生命值上限
- **材料**: 金线藤×4, 青灵草×2
- **炼制要求**: 炼丹等级2
- **成功率**: 80%
- **产出数量**: 1颗
- **灵力消耗**: 50
- **炼制时长**: 1小时
- **灵石成本**: 1500

#### 6. 清心丹（去除负面状态）
- **效果**: 解除中毒、虚弱等负面状态
- **材料**: 寒冰莲×2, 碧心花×3
- **炼制要求**: 炼丹等级2
- **成功率**: 75%
- **产出数量**: 1-2颗
- **灵力消耗**: 60
- **炼制时长**: 1.5小时
- **灵石成本**: 2000

#### 7. 疾速丹（短时提升速度）
- **效果**: 30分钟内速度+50%
- **材料**: 金线藤×3, 紫云芝×3
- **炼制要求**: 炼丹等级3
- **成功率**: 75%
- **产出数量**: 1-2颗
- **灵力消耗**: 60
- **炼制时长**: 1.5小时
- **灵石成本**: 2500

#### 8. 防御丹（短时提升防御）
- **效果**: 30分钟内防御+50%
- **材料**: 金刚果×2, 青灵草×4
- **炼制要求**: 炼丹等级3
- **成功率**: 70%
- **产出数量**: 1-2颗
- **灵力消耗**: 60
- **炼制时长**: 1.5小时
- **灵石成本**: 3000

---

### 二、灵品丹药（10种）

#### 9. 筑基丹（辅助筑基）
- **效果**: 提升50%筑基成功率
- **材料**: 玉随芝×2, 紫云芝×5, 碧心花×5
- **炼制要求**: 炼丹等级5
- **成功率**: 60%
- **产出数量**: 1颗
- **灵力消耗**: 100
- **炼制时长**: 4小时
- **灵石成本**: 50000

#### 10. 大回春丹（高级疗伤）
- **效果**: 恢复2000点生命值
- **材料**: 青灵草×5, 玉随芝×1, 寒冰莲×2
- **炼制要求**: 炼丹等级4
- **成功率**: 65%
- **产出数量**: 1-2颗
- **灵力消耗**: 80
- **炼制时长**: 2小时
- **灵石成本**: 8000

#### 11. 大聚灵丹（高级恢复灵力）
- **效果**: 恢复1000点灵力
- **材料**: 碧心花×5, 玉随芝×1, 紫云芝×3
- **炼制要求**: 炼丹等级4
- **成功率**: 65%
- **产出数量**: 1-2颗
- **灵力消耗**: 80
- **炼制时长**: 2小时
- **灵石成本**: 6000

#### 12. 增元丹（大幅增加修为）
- **效果**: 获得3000点修为经验
- **材料**: 紫云芝×6, 玉随芝×1, 赤火果×2
- **炼制要求**: 炼丹等级5
- **成功率**: 60%
- **产出数量**: 1颗
- **灵力消耗**: 100
- **炼制时长**: 3小时
- **灵石成本**: 15000

#### 13. 火灵丹（提升火属性法术威力）
- **效果**: 7天内火属性法术伤害+30%
- **材料**: 赤火果×3, 紫云芝×3, 金线藤×2
- **炼制要求**: 炼丹等级5,需要火灵根
- **成功率**: 55%
- **产出数量**: 1颗
- **灵力消耗**: 90
- **炼制时长**: 2小时
- **灵石成本**: 10000

#### 14. 冰魄丹（提升水属性法术威力）
- **效果**: 7天内水属性法术伤害+30%
- **材料**: 寒冰莲×3, 紫云芝×3, 碧心花×3
- **炼制要求**: 炼丹等级5,需要水灵根
- **成功率**: 55%
- **产出数量**: 1颗
- **灵力消耗**: 90
- **炼制时长**: 2小时
- **灵石成本**: 10000

#### 15. 破障丹（辅助小境界突破）
- **效果**: 炼气期小境界突破成功率+20%
- **材料**: 玉随芝×1, 紫云芝×5, 九幽草×2
- **炼制要求**: 炼丹等级6
- **成功率**: 50%
- **产出数量**: 1颗
- **灵力消耗**: 120
- **炼制时长**: 3小时
- **灵石成本**: 20000

#### 16. 金身丹（永久增强防御）
- **效果**: 永久增加50点防御力
- **材料**: 金刚果×3, 玉随芝×1, 金线藤×5
- **炼制要求**: 炼丹等级6
- **成功率**: 50%
- **产出数量**: 1颗
- **灵力消耗**: 120
- **炼制时长**: 3小时
- **灵石成本**: 25000

#### 17. 疗毒丹（治疗剧毒）
- **效果**: 解除所有中毒效果,恢复500生命
- **材料**: 九幽草×4, 寒冰莲×2, 碧心花×3
- **炼制要求**: 炼丹等级6
- **成功率**: 55%
- **产出数量**: 1-2颗
- **灵力消耗**: 100
- **炼制时长**: 2.5小时
- **灵石成本**: 12000

#### 18. 灵智丹（提升悟性）
- **效果**: 7天内修炼速度+20%,顿悟几率+5%
- **材料**: 紫云芝×5, 玉随芝×1, 星月露×1
- **炼制要求**: 炼丹等级7
- **成功率**: 45%
- **产出数量**: 1颗
- **灵力消耗**: 150
- **炼制时长**: 4小时
- **灵石成本**: 35000

---

### 三、宝品丹药（8种）

#### 19. 凝金丹（辅助结丹）
- **效果**: 提升30%结丹成功率
- **材料**: 天灵果×1, 玉随芝×3, 紫髓晶×1
- **炼制要求**: 炼丹等级10
- **成功率**: 40%
- **产出数量**: 1颗
- **灵力消耗**: 200
- **炼制时长**: 8小时
- **灵石成本**: 250000

#### 20. 返魂丹（起死回生）
- **效果**: 濒死状态下恢复50%生命和灵力
- **材料**: 玉随芝×5, 龙血草×1, 寒冰莲×5
- **炼制要求**: 炼丹等级9
- **成功率**: 35%
- **产出数量**: 1颗
- **灵力消耗**: 180
- **炼制时长**: 6小时
- **灵石成本**: 100000

#### 21. 金丹培元丹（金丹期修为丹药）
- **效果**: 获得20000点修为经验
- **材料**: 天灵果×1, 紫云芝×10, 赤火果×3
- **炼制要求**: 炼丹等级11
- **成功率**: 35%
- **产出数量**: 1颗
- **灵力消耗**: 250
- **炼制时长**: 8小时
- **灵石成本**: 300000

#### 22. 龙虎丹（大幅提升战力）
- **效果**: 1小时内攻击+100%,防御+50%
- **材料**: 龙血草×2, 金刚果×5, 赤火果×3
- **炼制要求**: 炼丹等级10
- **成功率**: 40%
- **产出数量**: 1颗
- **灵力消耗**: 200
- **炼制时长**: 6小时
- **灵石成本**: 150000

#### 23. 破瓶丹（辅助金丹期小境界突破）
- **效果**: 金丹期小境界突破成功率+30%
- **材料**: 天灵果×1, 九幽草×5, 紫髓晶×1
- **炼制要求**: 炼丹等级11
- **成功率**: 30%
- **产出数量**: 1颗
- **灵力消耗**: 250
- **炼制时长**: 10小时
- **灵石成本**: 400000

#### 24. 五行丹（五行法术增强）
- **效果**: 30天内所有五行法术伤害+50%
- **材料**: 赤火果×2, 寒冰莲×2, 金刚果×2, 紫云芝×5
- **炼制要求**: 炼丹等级12
- **成功率**: 30%
- **产出数量**: 1颗
- **灵力消耗**: 300
- **炼制时长**: 10小时
- **灵石成本**: 500000

#### 25. 紫髓丹（疗伤圣药）
- **效果**: 恢复8000点生命值,治愈重伤
- **材料**: 紫髓晶×2, 龙血草×1, 玉随芝×5
- **炼制要求**: 炼丹等级11
- **成功率**: 35%
- **产出数量**: 1颗
- **灵力消耗**: 250
- **炼制时长**: 8小时
- **灵石成本**: 350000

#### 26. 固元丹（永久增加灵力上限）
- **效果**: 永久增加100点灵力上限
- **材料**: 天灵果×1, 碧心花×10, 星月露×2
- **炼制要求**: 炼丹等级12
- **成功率**: 30%
- **产出数量**: 1颗
- **灵力消耗**: 300
- **炼制时长**: 10小时
- **灵石成本**: 600000

---

### 四、仙品丹药（6种）

#### 27. 破婴丹（辅助凝婴）
- **效果**: 提升20%元婴突破成功率
- **材料**: 血参精×1, 凤羽花×2, 紫髓晶×3
- **炼制要求**: 炼丹等级15
- **成功率**: 20%
- **产出数量**: 1颗
- **灵力消耗**: 500
- **炼制时长**: 24小时
- **灵石成本**: 2000000

#### 28. 元婴培元丹（元婴期修为丹药）
- **效果**: 获得100000点修为经验
- **材料**: 血参精×1, 天灵果×3, 龙血草×2
- **炼制要求**: 炼丹等级14
- **成功率**: 25%
- **产出数量**: 1颗
- **灵力消耗**: 400
- **炼制时长**: 16小时
- **灵石成本**: 1500000

#### 29. 涅槃丹（复活丹药）
- **效果**: 死亡后自动复活,恢复50%状态
- **材料**: 血参精×1, 凤羽花×1, 龙血草×2, 紫髓晶×2
- **炼制要求**: 炼丹等级16
- **成功率**: 15%
- **产出数量**: 1颗
- **灵力消耗**: 600
- **炼制时长**: 24小时
- **灵石成本**: 3000000

#### 30. 化婴丹（强化元婴）
- **效果**: 永久增加200点所有属性
- **材料**: 血参精×2, 天灵果×3, 星月露×5
- **炼制要求**: 炼丹等级17
- **成功率**: 15%
- **产出数量**: 1颗
- **灵力消耗**: 600
- **炼制时长**: 30小时
- **灵石成本**: 5000000

#### 31. 续命丹（延寿丹药）
- **效果**: 延长寿元100年
- **材料**: 血参精×1, 玉随芝×10, 寒冰莲×10
- **炼制要求**: 炼丹等级15
- **成功率**: 20%
- **产出数量**: 1颗
- **灵力消耗**: 500
- **炼制时长**: 20小时
- **灵石成本**: 2500000

#### 32. 神通丹（领悟神通）
- **效果**: 有一定几率领悟一门神通技能
- **材料**: 凤羽花×1, 龙血草×2, 天灵果×2, 星月露×3
- **炼制要求**: 炼丹等级18
- **成功率**: 10%
- **产出数量**: 1颗
- **灵力消耗**: 800
- **炼制时长**: 36小时
- **灵石成本**: 8000000

---

### 五、神品丹药（4种）

#### 33. 化神丹（辅助化神）
- **效果**: 提升15%化神突破成功率
- **材料**: 化神花×1, 血参精×3, 凤羽花×3, 紫髓晶×5
- **炼制要求**: 炼丹等级20
- **成功率**: 8%
- **产出数量**: 1颗
- **灵力消耗**: 1000
- **炼制时长**: 48小时
- **灵石成本**: 20000000

#### 34. 化神培元丹（化神期修为丹药）
- **效果**: 获得500000点修为经验
- **材料**: 化神花×1, 血参精×2, 天灵果×5
- **炼制要求**: 炼丹等级19
- **成功率**: 10%
- **产出数量**: 1颗
- **灵力消耗**: 800
- **炼制时长**: 40小时
- **灵石成本**: 15000000

#### 35. 天劫丹（抵抗天劫）
- **效果**: 渡劫时抵抗一次天雷攻击
- **材料**: 化神花×1, 凤羽花×3, 龙血草×3, 星月露×10
- **炼制要求**: 炼丹等级21
- **成功率**: 5%
- **产出数量**: 1颗
- **灵力消耗**: 1200
- **炼制时长**: 72小时
- **灵石成本**: 30000000

#### 36. 大还丹（起死回生圣药）
- **效果**: 完全恢复所有生命和灵力,治愈一切伤势
- **材料**: 血参精×5, 紫髓晶×10, 龙血草×5, 玉随芝×20
- **炼制要求**: 炼丹等级20
- **成功率**: 8%
- **产出数量**: 1颗
- **灵力消耗**: 1000
- **炼制时长**: 48小时
- **灵石成本**: 25000000

---

## 🎓 炼丹等级系统

### 等级划分

| 等级 | 称号 | 经验要求 | 可炼制品级 | 成功率加成 |
|------|------|---------|-----------|-----------|
| 1-3 | 炼丹学徒 | 0 - 5000 | 凡品 | +0% |
| 4-7 | 炼丹师 | 5000 - 20000 | 凡品、灵品 | +5% |
| 8-12 | 高级炼丹师 | 20000 - 100000 | 凡品、灵品、宝品 | +10% |
| 13-18 | 炼丹宗师 | 100000 - 500000 | 凡品、灵品、宝品、仙品 | +15% |
| 19-21 | 炼丹大宗师 | 500000 - 2000000 | 全部 | +20% |
| 22+ | 丹道仙人 | 2000000+ | 全部 | +25% |

### 经验获取

**炼制成功**：
- 凡品丹药：50-150 经验
- 灵品丹药：200-500 经验
- 宝品丹药：600-1500 经验
- 仙品丹药：2000-5000 经验
- 神品丹药：6000-15000 经验

**炼制失败**：获得50%经验

---

## ⚙️ 炼丹机制

### 成功率计算
```
最终成功率 = 基础成功率 × (1 + 炼丹等级加成) × (1 + 功法加成) × (1 + 灵根加成)
最大不超过95%
```

### 功法加成
- **青竹玄心诀**：+50%炼丹成功率（神级功法特效）
- **火属性功法**：炼制火属性丹药+10%
- **木属性功法**：炼制疗伤类丹药+10%

### 灵根加成
- **单属性灵根**：对应属性丹药+5%
- **双属性灵根**：对应属性丹药+3%

### 产出数量
- 基础数量：配方规定的最小-最大值
- 炼丹等级每10级：+10%额外产出几率
- 大成功（5%几率）：产出数量×2

---

## 💰 经济系统

### 灵石消耗

丹药炼制会消耗大量灵石用于购买材料和维持丹炉:

- **凡品丹药**：500-3,000灵石
- **灵品丹药**：6,000-50,000灵石
- **宝品丹药**：100,000-600,000灵石
- **仙品丹药**：1,500,000-8,000,000灵石
- **神品丹药**：15,000,000-30,000,000灵石

### 市场价值

成功炼制的丹药可以:
1. 自用提升实力
2. 出售获得利润（售价通常为成本的150-300%）
3. 交易给其他玩家
4. 宗门贡献换取贡献度

---

## 📊 数据总览

### 配方统计

| 品级 | 数量 | 基础成功率 | 平均材料数 | 平均炼制时长 |
|------|------|-----------|-----------|-------------|
| 凡品 | 8 | 70-90% | 3-4种 | 0.5-1.5小时 |
| 灵品 | 10 | 45-65% | 4-5种 | 2-4小时 |
| 宝品 | 8 | 30-40% | 4-6种 | 6-10小时 |
| 仙品 | 6 | 10-25% | 5-7种 | 16-36小时 |
| 神品 | 4 | 5-10% | 6-8种 | 40-72小时 |
| **总计** | **36** | - | - | - |

### 材料统计

- 基础灵草：4种
- 中级灵药：5种
- 高级灵物：5种
- 顶级仙药：2种
- **总计**：16种材料

---

## 🚀 实装步骤

### 1. 创建材料数据
首先在 `init_mortal_data.py` 或单独创建材料初始化:
- 16种炼丹材料（HERB类型）
- 设置年份、稀有度、价格

### 2. 创建丹药物品
创建36种丹药物品（PILL类型）到 items 表:
- 效果属性
- 价格
- 使用要求

### 3. 创建丹方配方
运行 `scripts/init_alchemy_system.py`:
- 创建36条丹方记录
- 关联材料和产出丹药
- 设置炼制参数

### 4. 测试验证
- 测试各等级丹方是否正确创建
- 验证材料关联是否正确
- 检查数值平衡性

---

## 📁 相关文件

### 数据模型
- `src/bot/models/alchemy.py` - 炼丹系统模型（已存在）

### 初始化脚本
- `scripts/init_alchemy_system.py` - 炼丹系统初始化脚本（待创建）

### 业务逻辑
- `src/bot/handlers/alchemy.py` - 炼丹命令处理器（已存在）
- `src/bot/services/alchemy_service.py` - 炼丹服务（如需要）

### 文档
- `docs/ALCHEMY_SYSTEM_DESIGN.md` - 本设计文档

---

## 📝 开发笔记

### 设计考量

1. **平衡性**：高级丹药需要极多材料和时间,避免快速获取
2. **经济循环**：通过炼丹消耗大量灵石,促进经济流通
3. **原著还原**：筑基丹、凝金丹、破婴丹等核心丹药完全还原
4. **玩法深度**：材料收集、配方研究、炼制成功率管理

### 未来扩展

- 丹方学习系统（从书籍、NPC、秘境中获取）
- 炼丹炉品质系统（影响成功率和产出）
- 丹药品质系统（普通/优质/极品）
- 特殊丹方（限定活动获取）

---

**设计完成日期**: 2025-01-25
**状态**: ✅ 设计完成，准备实装
**总丹方数**: 36种
**总材料数**: 16种
