

# 积分同步系统部署指南

## 概述

本指南说明如何部署和配置跨项目积分同步系统，实现两个或多个项目间的积分打通。

---

## 系统架构

```
┌─────────────────┐         ┌─────────────────┐
│   修仙游戏Bot    │         │   媒体Bot项目    │
│  (Project A)    │         │  (Project B)    │
└────────┬────────┘         └────────┬────────┘
         │                            │
         │  HTTP API调用               │
         │  (带验证令牌)               │
         │                            │
         └──────────┬─────────────────┘
                    │
         ┌──────────▼──────────┐
         │   积分同步API        │
         │  (FastAPI服务)      │
         └──────────┬──────────┘
                    │
         ┌──────────▼──────────┐
         │   统一积分数据库     │
         │  (SQLite/PostgreSQL)│
         └─────────────────────┘
```

---

## 部署步骤

### 1. 环境要求

**Python版本**: 3.11+

**依赖包**:
```bash
pip install fastapi
pip install uvicorn[standard]
pip install sqlalchemy[asyncio]
pip install aiosqlite  # 或 asyncpg (PostgreSQL)
pip install python-telegram-bot
pip install requests
pip install pydantic
```

或使用requirements.txt:
```bash
pip install -r requirements.txt
```

---

### 2. 配置API密钥

编辑 `src/bot/api/credit_sync_api.py`，配置有效的API密钥：

```python
# 在 verify_api_key 函数中修改
VALID_API_KEYS = [
    "xiuxian-api-key-2024",      # 修仙游戏项目
    "media-bot-api-key-2024",    # 媒体Bot项目
    "your-custom-api-key"        # 添加更多项目
]
```

**安全建议**:
- 使用随机生成的强密钥（至少32字符）
- 不要将密钥提交到版本控制
- 定期轮换密钥

生成密钥示例:
```python
import secrets
api_key = secrets.token_urlsafe(32)
print(api_key)
```

---

### 3. 配置同步密钥

编辑 `src/bot/services/credit_sync_service.py`，设置同步密钥：

```python
class CreditSyncService:
    # 建议从环境变量读取
    SYNC_SECRET_KEY = os.getenv("CREDIT_SYNC_SECRET", "your-secret-key-here")
```

**生产环境配置**:
```bash
# .env 文件
CREDIT_SYNC_SECRET=your-very-secure-secret-key-here
```

---

### 4. 注册API路由

在主应用中注册积分同步API路由。

**如果使用FastAPI**:
```python
# src/bot/main.py 或独立的 api_server.py

from fastapi import FastAPI
from bot.api.credit_sync_api import router as credit_router

app = FastAPI(title="修仙游戏API")

# 注册积分同步路由
app.include_router(credit_router)

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)
```

**如果需要独立API服务器**:
```python
# api_server.py

from fastapi import FastAPI
from bot.api.credit_sync_api import router as credit_router
from bot.models import init_db, close_db

app = FastAPI(
    title="积分同步API",
    version="1.0.0",
    description="跨项目积分同步服务"
)

@app.on_event("startup")
async def startup():
    """启动时初始化数据库"""
    await init_db()

@app.on_event("shutdown")
async def shutdown():
    """关闭时清理资源"""
    await close_db()

app.include_router(credit_router)

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        log_level="info"
    )
```

---

### 5. 启动API服务

**开发环境**:
```bash
python api_server.py
```

或使用uvicorn:
```bash
uvicorn api_server:app --reload --host 0.0.0.0 --port 8000
```

**生产环境**（使用Supervisor）:
```ini
# /etc/supervisor/conf.d/credit_sync_api.conf

[program:credit_sync_api]
command=/usr/bin/python3 /path/to/api_server.py
directory=/path/to/project
user=www-data
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/credit_sync_api.log
```

**生产环境**（使用Systemd）:
```ini
# /etc/systemd/system/credit_sync_api.service

[Unit]
Description=Credit Sync API Service
After=network.target

[Service]
Type=simple
User=www-data
WorkingDirectory=/path/to/project
Environment="CREDIT_SYNC_SECRET=your-secret-key"
ExecStart=/usr/bin/python3 /path/to/api_server.py
Restart=always

[Install]
WantedBy=multi-user.target
```

启动服务:
```bash
sudo systemctl daemon-reload
sudo systemctl start credit_sync_api
sudo systemctl enable credit_sync_api
sudo systemctl status credit_sync_api
```

---

### 6. 配置Nginx反向代理

**安全建议**: 不要直接暴露API服务，使用Nginx作为反向代理。

```nginx
# /etc/nginx/sites-available/credit_sync_api

server {
    listen 80;
    server_name api.yourdomain.com;

    # 强制HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name api.yourdomain.com;

    # SSL证书配置
    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    # 安全配置
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # 限流
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
    limit_req zone=api_limit burst=20 nodelay;

    location /api/credits/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }

    # API文档（可选，生产环境建议关闭）
    location /docs {
        proxy_pass http://127.0.0.1:8000;
    }

    location /redoc {
        proxy_pass http://127.0.0.1:8000;
    }
}
```

启用站点:
```bash
sudo ln -s /etc/nginx/sites-available/credit_sync_api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

---

## 客户端集成

### 方式1：使用Python SDK

**安装SDK**:
```python
# 复制 credit_sync_client.py 到项目中
from credit_sync_client import CreditSyncClient

# 初始化客户端
client = CreditSyncClient(
    base_url="https://api.yourdomain.com",
    api_key="media-bot-api-key-2024",
    secret_key="your-secret-key-here",
    source="media_bot"
)

# 增加积分
result = client.add_credits(
    telegram_id=123456789,
    amount=100,
    reason="观看视频奖励",
    reference="video_12345"
)

if result.success:
    print(f"成功！当前余额：{result.balance}")
else:
    print(f"失败：{result.message}")
```

---

### 方式2：直接HTTP请求

**Python示例**:
```python
import requests
import time
import hmac
import hashlib

def sync_credits(telegram_id, amount, reason):
    # 配置
    API_URL = "https://api.yourdomain.com/api/credits/sync"
    API_KEY = "your-api-key"
    SECRET = "your-secret-key"
    SOURCE = "media_bot"

    # 生成令牌
    timestamp = int(time.time())
    message = f"{telegram_id}:{amount}:{SOURCE}:{timestamp}"
    token = hmac.new(
        SECRET.encode(),
        message.encode(),
        hashlib.sha256
    ).hexdigest()

    # 发送请求
    response = requests.post(
        API_URL,
        json={
            "telegram_id": telegram_id,
            "amount": amount,
            "source": SOURCE,
            "reason": reason,
            "timestamp": timestamp,
            "token": token
        },
        headers={"X-Api-Key": API_KEY}
    )

    return response.json()
```

---

## 监控和日志

### 1. 日志配置

```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/var/log/credit_sync.log'),
        logging.StreamHandler()
    ]
)
```

### 2. 性能监控

建议使用以下工具监控API性能：
- **Prometheus** + **Grafana**: 指标监控
- **Sentry**: 错误追踪
- **ELK Stack**: 日志分析

### 3. 健康检查端点

```python
@app.get("/health")
async def health_check():
    """健康检查"""
    return {"status": "ok", "timestamp": time.time()}
```

---

## 安全最佳实践

### 1. HTTPS加密
- ✅ 生产环境必须使用HTTPS
- ✅ 使用Let's Encrypt免费证书

### 2. API密钥管理
- ✅ 使用环境变量存储密钥
- ✅ 定期轮换密钥
- ✅ 为不同项目使用不同密钥

### 3. 限流保护
```nginx
# Nginx限流配置
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
```

### 4. IP白名单（可选）
```nginx
# 仅允许特定IP访问
allow 1.2.3.4;  # 媒体Bot服务器
allow 5.6.7.8;  # 其他可信服务器
deny all;
```

### 5. 请求签名验证
- ✅ 已实现HMAC-SHA256签名
- ✅ 时间戳验证（5分钟有效期）
- ✅ 防重放攻击

---

## 故障排查

### 问题1：令牌验证失败
**可能原因**:
- 密钥不匹配
- 时间戳过期
- 客户端和服务器时间不同步

**解决方案**:
```bash
# 同步服务器时间
sudo ntpdate pool.ntp.org
```

### 问题2：用户不存在
**可能原因**:
- Telegram ID错误
- 用户未在游戏中注册

**解决方案**:
- 先让用户在游戏中使用 `/检测灵根` 注册
- 确认Telegram ID正确

### 问题3：重复同步
**解决方案**:
- 使用 `external_reference` 字段去重
- 检查是否多次发送相同请求

---

## 数据备份

### 自动备份脚本

```bash
#!/bin/bash
# backup_credits.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups/credits"
DB_PATH="/path/to/xiuxian_game.db"

mkdir -p $BACKUP_DIR

# 备份数据库
sqlite3 $DB_PATH ".backup '$BACKUP_DIR/credits_$DATE.db'"

# 保留最近7天的备份
find $BACKUP_DIR -name "credits_*.db" -mtime +7 -delete

echo "Backup completed: $BACKUP_DIR/credits_$DATE.db"
```

添加到crontab:
```bash
# 每天凌晨2点备份
0 2 * * * /path/to/backup_credits.sh
```

---

## 性能优化

### 1. 数据库优化
- 添加索引（已在模型中定义）
- 定期清理旧记录
- 考虑使用PostgreSQL替代SQLite

### 2. 缓存策略
```python
from functools import lru_cache

@lru_cache(maxsize=1000)
def get_player_balance(telegram_id):
    # 缓存玩家余额
    pass
```

### 3. 批量操作
- 使用批量同步接口减少请求次数
- 合并多个用户的积分变动

---

## 测试

### 单元测试
```bash
pytest tests/test_credit_sync.py -v
```

### API测试
```bash
# 使用curl测试
curl -X POST https://api.yourdomain.com/api/credits/sync \
  -H "X-Api-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "telegram_id": 123456789,
    "amount": 100,
    "source": "media_bot",
    "reason": "测试",
    "timestamp": 1234567890,
    "token": "your-token"
  }'
```

---

## 常见配置示例

### Docker部署
```dockerfile
# Dockerfile

FROM python:3.11-slim

WORKDIR /app

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

EXPOSE 8000

CMD ["python", "api_server.py"]
```

```yaml
# docker-compose.yml

version: '3.8'

services:
  credit_sync_api:
    build: .
    ports:
      - "8000:8000"
    environment:
      - CREDIT_SYNC_SECRET=${CREDIT_SYNC_SECRET}
    volumes:
      - ./data:/app/data
    restart: always
```

---

## 更新日志

### v1.0.0 (2024-01-XX)
- ✅ 初始版本
- ✅ 支持单笔和批量同步
- ✅ 提供Python SDK
- ✅ 完整的安全验证

---

**维护者**: 开发团队
**最后更新**: 2024-01-XX
