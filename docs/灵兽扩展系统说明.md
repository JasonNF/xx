# 灵兽扩展系统说明

## 概述

本次更新为灵兽系统添加了三个核心扩展功能：**天赋系统**、**进化系统**和**融合系统**，大幅提升灵兽养成的深度和可玩性。

---

## 🎯 一、天赋系统

### 系统介绍

每只灵兽在捕捉时会随机获得1-3个天赋，天赋数量由品质决定：
- **凡品**：1个天赋
- **仙品**：1-2个天赋
- **神品**：2-3个天赋

### 天赋稀有度

天赋分为四个稀有度等级，获得概率不同：

| 稀有度 | 标记 | 权重 | 获得概率 |
|--------|------|------|----------|
| 普通 | ⚪ | 50 | 50% |
| 稀有 | 🔵 | 30 | 30% |
| 史诗 | 🟣 | 15 | 15% |
| 传说 | 🟡 | 5 | 5% |

### 天赋类型

#### 攻击系天赋（5种）

| 天赋 | 稀有度 | 效果 |
|------|--------|------|
| 💥 暴击 | 稀有 | 增加15%暴击率，暴击伤害+50% |
| 🗡️ 破甲 | 稀有 | 攻击无视敌人30%防御 |
| ⚔️ 连击 | 史诗 | 20%概率连续攻击2次 |
| 🩸 吸血 | 稀有 | 攻击回复造成伤害20%的生命值 |
| 😡 狂怒 | 史诗 | 生命值低于50%时攻击力+40% |

#### 防御系天赋（5种）

| 天赋 | 稀有度 | 效果 |
|------|--------|------|
| 🛡️ 格挡 | 普通 | 减少受到伤害的25% |
| ⚡ 反伤 | 稀有 | 反弹受到伤害的30% |
| 🔰 护盾 | 史诗 | 受致命伤时触发护盾，免疫并恢复30%生命值（冷却3回合）|
| 💚 回复 | 普通 | 每回合恢复5%生命值 |
| 🔩 铁皮 | 普通 | 防御力+30% |

#### 速度系天赋（4种）

| 天赋 | 稀有度 | 效果 |
|------|--------|------|
| ⚡ 先攻 | 稀有 | 战斗开始时必定先手 |
| 💨 闪避 | 稀有 | 25%概率闪避攻击 |
| 🏃 追击 | 史诗 | 击败敌人后可额外攻击一次 |
| 💫 迅捷 | 稀有 | 速度+50% |

#### 特殊系天赋（5种）

| 天赋 | 稀有度 | 效果 |
|------|--------|------|
| 🔮 灵气共鸣 | 传说 | 主人修炼速度+15% |
| 🌟 元素精通 | 史诗 | 元素伤害+40% |
| 🔥 战意 | 史诗 | 每次战斗获得+5%攻击力，最多叠加10层 |
| 🍀 幸运 | 传说 | 提升10%捕捉成功率和掉落概率 |
| 📚 睿智 | 稀有 | 经验获取+30% |

### 使用方式

- 捕捉灵兽时自动生成天赋
- 使用 `/灵兽` 命令查看灵兽的天赋
- 进化时有30%概率获得新天赋
- 融合时继承两只灵兽的所有天赋（最多4个）

---

## ⭐ 二、进化系统

### 系统介绍

仙品和神品灵兽可以进化，最多进化3次（0阶 → 1阶 → 2阶 → 3阶）。

### 进化条件

每次进化需要满足以下条件：

| 进化阶段 | 等级要求 | 亲密度要求 | 灵石消耗 |
|----------|----------|------------|----------|
| 0 → 1 | Lv.10 | 60 | 50,000 |
| 1 → 2 | Lv.20 | 80 | 100,000 |
| 2 → 3 | Lv.30 | 100 | 150,000 |

### 进化效果

每次进化获得以下提升：
- **属性提升**：+50%基础属性
  - 攻击力 +50%
  - 防御力 +50%
  - 生命值 +50%
- **天赋加成**：30%概率获得1个新天赋
- **成长率提升**：每级成长更快
- **外观标记**：获得进化星标 ⭐

### 进化限制

- 凡品灵兽**无法进化**
- 训练中或出战中的灵兽无法进化
- 进化后灵兽将满血复活

### 使用方式

```
/灵兽进化 <灵兽昵称>
```

**示例**：
```
/灵兽进化 玄冰蛟龙
```

---

## 🌟 三、融合系统

### 系统介绍

将两只灵兽融合为一只全新的强力灵兽。融合后原有灵兽消失。

### 融合条件

| 条件 | 要求 |
|------|------|
| 品质 | 两只灵兽必须是**相同品质** |
| 等级 | 两只灵兽都需达到 **Lv.10** |
| 亲密度 | 两只灵兽亲密度都需达到 **50** |
| 状态 | 不能在训练中或出战中 |
| 灵石消耗 | **50,000** 灵石 |

### 融合结果

融合后生成新灵兽，具有以下特性：

#### 属性计算
- **攻击力**：取较高值 × 1.1
- **防御力**：取较高值 × 1.1
- **生命值**：取较高值 × 1.1
- **速度**：取较高值 × 1.1
- **等级**：取较高值

#### 天赋继承
- 合并两只灵兽的所有天赋（去重）
- 最多保留 **4个天赋**

#### 灵兽种类
- 随机从相同品质的灵兽中选择

### 融合策略

**最佳融合组合**：
1. **同种双子**：两只相同种类的高级灵兽
2. **天赋互补**：一只攻击型 + 一只防御型
3. **等级匹配**：两只等级接近的灵兽

**注意事项**：
- ⚠️ 融合不可逆，原灵兽将永久消失
- 💡 建议融合前先查看灵兽属性和天赋
- 🎲 融合结果有随机性，可能出现稀有灵兽

### 使用方式

```
/灵兽融合 <灵兽1昵称> <灵兽2昵称>
```

**示例**：
```
/灵兽融合 青风狼 烈焰鼠
```

---

## 📊 系统特性对比

| 系统 | 获得方式 | 资源消耗 | 主要效果 | 适用场景 |
|------|----------|----------|----------|----------|
| **天赋** | 捕捉时随机 | 无 | 独特能力加成 | 提升灵兽个性 |
| **进化** | 满足条件后进化 | 5-15万灵石 | +50%属性，可能获得新天赋 | 提升单只灵兽实力 |
| **融合** | 两只灵兽融合 | 5万灵石 | 继承属性和天赋，生成新灵兽 | 整合多余灵兽 |

---

## 🎮 新增命令列表

| 命令 | 功能 | 用法 |
|------|------|------|
| `/灵兽进化 <昵称>` | 进化灵兽 | `/灵兽进化 玄冰蛟龙` |
| `/灵兽融合 <昵称1> <昵称2>` | 融合两只灵兽 | `/灵兽融合 青风狼 烈焰鼠` |

---

## 💡 养成建议

### 新手阶段（凡品灵兽）
1. 捕捉多只凡品灵兽测试天赋
2. 选择有"睿智"或"灵气共鸣"天赋的灵兽培养
3. 凡品灵兽无法进化，可用于融合练习

### 成长阶段（仙品灵兽）
1. 优先培养攻击型灵兽进化
2. 达到Lv.10时考虑融合重复灵兽
3. 进化至1-2阶后重点培养

### 巅峰阶段（神品灵兽）
1. 神品灵兽必定有2-3个天赋，极其珍贵
2. 优先进化至3阶（+150%属性）
3. 融合神品灵兽可能获得顶级天赋组合

---

## 🗄️ 数据库迁移

### 新用户部署

直接执行初始化SQL，已包含所有扩展字段。

### 现有数据库升级

```bash
# 1. 备份数据库
cp data/xiuxian.db data/xiuxian.db.backup.$(date +%Y%m%d)

# 2. 执行迁移
sqlite3 data/xiuxian.db < data/migrations/add_beast_extensions.sql

# 3. 验证迁移
sqlite3 data/xiuxian.db "PRAGMA table_info(player_spirit_beasts);"
```

**迁移内容**：
- 添加 `talents` 字段（TEXT）
- 添加 `evolution_stage` 字段（INTEGER）
- 创建 `beast_evolution_records` 表
- 创建 `beast_fusion_records` 表

---

## 📈 系统设计理念

### 天赋系统
- **目标**：增加灵兽独特性和培养深度
- **实现**：随机生成，品质越高天赋越多
- **平衡**：传说天赋稀有但强力，普通天赋常见但实用

### 进化系统
- **目标**：提供灵兽成长深度
- **实现**：需要时间和资源投入
- **平衡**：凡品无法进化，仙品和神品可进化3次

### 融合系统
- **目标**：处理多余灵兽，创造新可能
- **实现**：同品质融合，继承天赋和属性
- **平衡**：融合需要高成本，结果有随机性

---

## 🔮 未来扩展

可能的扩展方向：
1. **天赋觉醒**：低级天赋进化为高级天赋
2. **特殊进化路线**：特定灵兽进化为传说形态
3. **融合配方**：特定组合融合出固定灵兽
4. **天赋转移**：将天赋转移到其他灵兽
5. **灵兽羁绊**：特定组合灵兽出战获得额外加成

---

## 📞 技术支持

如遇问题，请查阅：
- 数据模型：`src/bot/models/spirit_beast.py`
- 服务层：`src/bot/services/spirit_beast_service.py`
- 天赋配置：`src/bot/config/talent_config.py`
- 命令处理器：`src/bot/handlers/spirit_beast.py`

---

**版本**：v2.0.0
**更新日期**：2025-01-XX
**作者**：Claude Code
