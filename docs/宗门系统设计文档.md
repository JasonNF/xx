# 宗门系统设计文档

## 📋 系统概述

宗门系统是修仙游戏的核心社交玩法之一,玩家可以加入不同宗门,通过完成宗门任务提升声望,晋升职位,学习宗门功法,最终挑战掌门获得宗门控制权。

### 核心特点
- **声望晋升**: 通过完成任务和捐献灵石提升声望,自动晋升职位
- **挑战掌门**: 长老以上可挑战掌门,获胜成为新掌门
- **功法学习**: 不同职位可学习不同等级的宗门功法
- **自由转换**: 可随时退出宗门加入其他宗门,已学功法保留
- **资源获取**: 掌门可获得宗门资源,商店可兑换物品

---

## 🎯 系统功能

### 1. 宗门分级

#### 宗门等级划分
| 等级 | 名称 | 加入所需声望 | 挑战掌门奖励 | 功法强度 |
|-----|------|-------------|-------------|---------|
| 1级 | 小型宗门 | 0 | 5,000声望 | 较低 |
| 2级 | 中型宗门 | 500 | 10,000声望 | 中等 |
| 3级 | 大型宗门 | 1,000 | 20,000声望 | 较高 |
| 4级 | 顶级宗门 | 3,000 | 50,000声望 | 高 |
| 5级 | 圣地宗门 | 10,000 | 100,000声望 | 极高 |

**设计说明**:
- 越高级的宗门,加入门槛越高,但功法更强
- 挑战掌门成功后获得的声望奖励与宗门等级成正比
- 玩家需要权衡"快速加入低级宗门"vs"积累声望加入高级宗门"

### 2. 职位系统

#### 职位等级与晋升

| 职位 | 所需声望 | 职位等级 | 权限 |
|-----|---------|---------|------|
| 外门弟子 | 0 | 1 | 基础权限 |
| 内门弟子 | 1,000 | 2 | 学习中级功法 |
| 真传弟子 | 5,000 | 3 | 学习高级功法 |
| 执事 | 10,000 | 4 | 学习精英功法 |
| 堂主 | 20,000 | 5 | 学习核心功法 |
| 长老 | 50,000 | 6 | 学习顶级功法,可挑战掌门 |
| 掌门 | 100,000+ | 7 | 最高权限,掌控宗门资源 |

**晋升机制**:
- 达到声望要求后**自动晋升**职位(掌门除外)
- 掌门职位需要**挑战现任掌门**并获胜才能获得
- 退出宗门后,总声望保留,可用于加入其他宗门

### 3. 声望获取

#### 声望来源

**主要途径**:
1. **完成宗门任务**
   - 日常任务: +50声望
   - 周常任务: +200声望
   - 特殊任务: +500声望

2. **捐献灵石**
   - 比例: 100灵石 = 1声望
   - 同时增加宗门金库

3. **挑战掌门成功**
   - 根据宗门等级获得大量声望奖励

**声望特性**:
- 总声望**永久累积**,退出宗门不会减少
- 加入宗门消耗一定声望,但不扣除总声望
- 声望是玩家实力和资历的象征

### 4. 功法学习系统

#### 传功长老

玩家可以在宗门的**传功长老**处学习功法:
- 不同职位可学习不同等级的功法
- 宗门等级越高,功法品质越好
- 学习后的功法**永久保留**,即使退出宗门

#### 功法分级示例

| 宗门等级 | 外门弟子功法 | 内门弟子功法 | 长老功法 |
|---------|------------|------------|---------|
| 小型宗门 | 人级 | 黄级 | 玄级 |
| 中型宗门 | 黄级 | 玄级 | 地级 |
| 大型宗门 | 玄级 | 地级 | 天级 |
| 顶级宗门 | 地级 | 天级 | 神级 |

### 5. 掌门挑战

#### 挑战条件
- 必须是**长老及以上**职位(声望≥50,000)
- 必须是本宗门成员
- 挑战成功后成为掌门

#### 挑战流程
1. 使用 `/挑战掌门` 命令发起挑战
2. 系统检查职位要求
3. 与现任掌门进行战斗(使用战斗系统)
4. 战斗获胜后:
   - 成为新任掌门
   - 获得大量声望奖励
   - 获得宗门金库10%的资源
   - 原掌门降为长老

#### 掌门特权
- 掌控宗门金库
- 设置宗门公告
- 管理宗门成员
- 升级宗门建筑

### 6. 宗门商店

#### 商店物品

玩家可使用**声望**在宗门商店兑换物品:
- 基础丹药(回春丹、聚灵丹等)
- 突破丹药(筑基丹、凝金丹等)
- 炼器材料(矿石、妖兽材料)
- 炼丹材料(灵草、灵药)

**兑换示例**:
| 物品 | 声望消耗 | 库存 |
|------|---------|------|
| 回春丹 | 100 | 无限 |
| 聚灵丹 | 150 | 无限 |
| 筑基丹 | 5,000 | 限量5个 |
| 凝金丹 | 20,000 | 限量3个 |

### 7. 退出与转换

#### 退出宗门规则
- 可随时使用 `/退出` 命令退出宗门
- **总声望保留**,可用于加入其他宗门
- **已学功法保留**,不会消失
- 掌门不能直接退出,需先禅让

#### 宗门转换策略
**策略1 - 稳扎稳打**:
- 加入小型宗门 → 快速提升声望 → 转入大型宗门

**策略2 - 一步到位**:
- 先积累足够声望 → 直接加入顶级宗门

**策略3 - 功法收集**:
- 在不同宗门学习不同功法 → 组合最强战力

---

## 📊 数值平衡

### 声望获取速度

| 玩家类型 | 每日声望获取 | 达到长老时间 |
|---------|-------------|------------|
| 休闲玩家 | 50-100 | 500-1000天 |
| 活跃玩家 | 200-500 | 100-250天 |
| 重度玩家 | 500-1000+ | 50-100天 |

### 经济平衡

**捐献收益**:
- 捐献10,000灵石 = 100声望
- 对于富有玩家,可以快速提升声望
- 避免纯金钱玩家:职位需声望,但功法学习需实力

**掌门收益**:
- 挑战成功奖励: 5,000-100,000声望
- 宗门资源分成: 10%金库
- 但维持掌门需要持续接受挑战

---

## 🗄️ 数据库设计

### 核心表结构

#### sects (宗门表)
```sql
CREATE TABLE sects (
    id INTEGER PRIMARY KEY,
    name VARCHAR(100) UNIQUE NOT NULL,
    description TEXT,
    faction ENUM,                    -- 阵营(正道/魔道/中立)
    region ENUM,                     -- 区域(天南/乱星海等)
    is_npc_sect BOOLEAN,             -- 是否NPC宗门
    master_id INTEGER,               -- 掌门ID
    level INTEGER DEFAULT 1,         -- 宗门等级(1-5)
    reputation INTEGER DEFAULT 0,    -- 宗门声望
    treasury BIGINT DEFAULT 0,       -- 金库
    max_members INTEGER DEFAULT 100, -- 最大成员数
    -- 建筑等级
    hall_level INTEGER DEFAULT 1,
    library_level INTEGER DEFAULT 1,
    alchemy_level INTEGER DEFAULT 1,
    refinery_level INTEGER DEFAULT 1,
    -- 设置
    auto_accept BOOLEAN DEFAULT FALSE,
    min_realm_requirement VARCHAR(50)
);
```

#### players (玩家表 - 宗门相关字段)
```sql
-- 宗门信息
sect_id INTEGER,              -- 所属宗门
sect_position VARCHAR(50),    -- 职位
contribution INTEGER DEFAULT 0 -- 总声望(累积)
```

**设计说明**:
- `contribution`字段用作总累积声望
- 声望永久保留,用于职位判定和宗门转换
- 职位根据声望自动计算,也可手动设置

#### sect_contributions (宗门贡献记录)
```sql
CREATE TABLE sect_contributions (
    id INTEGER PRIMARY KEY,
    sect_id INTEGER NOT NULL,
    player_id INTEGER NOT NULL,
    contribution_type VARCHAR(50), -- donate/task/battle
    amount INTEGER,                -- 获得的声望数量
    description TEXT,
    created_at DATETIME
);
```

#### sect_shop_items (宗门商店物品)
```sql
CREATE TABLE sect_shop_items (
    id INTEGER PRIMARY KEY,
    sect_id INTEGER NOT NULL,
    item_id INTEGER NOT NULL,
    contribution_cost INTEGER,      -- 声望消耗
    stock INTEGER DEFAULT -1,       -- 库存(-1=无限)
    required_level INTEGER DEFAULT 1 -- 宗门等级要求
);
```

---

## 🎮 游戏命令

### 基础命令

| 命令 | 功能 | 示例 |
|-----|-----|------|
| `/宗门` | 查看宗门信息 | `/宗门` |
| `/入门 <宗门名>` | 加入宗门 | `/入门 黄枫谷` |
| `/退出` | 退出宗门 | `/退出` |
| `/贡献 <数量>` | 捐献灵石获得声望 | `/贡献 1000` |
| `/宗门成员` | 查看成员列表 | `/宗门成员` |
| `/挑战掌门` | 挑战掌门(长老+) | `/挑战掌门` |
| `/兑换` | 查看宗门商店 | `/兑换` |

### 命令返回示例

#### /宗门
```
🏯 【黄枫谷】

天南七派之一,韩立所在门派,以炼制法器和符箓闻名

📊 宗门信息
阵营：正道
等级：5级 (顶级宗门)
声望：500000
成员：156/500

🏛️ 建筑等级
大殿：Lv.5
藏经阁：Lv.5
炼丹房：Lv.5
炼器阁：Lv.5

👤 你的身份
职位：内门弟子
声望：1500 (距离真传弟子还需3500声望)

━━━━━━━━━━━━━━
💡 命令：
• /贡献 <灵石数量> - 捐献灵石获得声望
• /兑换 - 宗门商店
• /宗门成员 - 查看成员列表
• /挑战掌门 - 挑战掌门(长老以上)
• /退出 - 退出宗门
```

#### /宗门成员
```
👥 【黄枫谷 成员榜】

掌门：韩立
总人数：156/500
━━━━━━━━━━━━━━

1. 韩立
   掌门 | 结丹期中期 | 150000声望

2. 南宫婉
   长老 | 结丹期初期 | 80000声望

3. 👤 李青
   内门弟子 | 筑基期后期 | 1500声望

...
```

#### /挑战掌门 (长老职位)
```
⚔️ 挑战掌门 韩立，请准备战斗！

战斗胜利后你将成为黄枫谷的新任掌门！
并获得大量声望和宗门资源！

💡 请使用战斗系统与掌门决斗
```

#### /挑战掌门 (胜利后)
```
🎉 挑战成功！你击败了 韩立，成为新任掌门！

获得：50000声望，500000灵石
```

---

## 🚀 后续扩展

### 短期计划
- [ ] 宗门任务系统 (日常/周常/特殊任务)
- [ ] 传功长老NPC (学习宗门功法)
- [ ] 宗门排行榜
- [ ] 宗门建筑升级功能

### 中期扩展
- [ ] 宗门战争系统 (已有基础代码)
- [ ] 宗门秘境 (宗门专属副本)
- [ ] 宗门联盟系统
- [ ] 宗门贡献任务板

### 长期规划
- [ ] 自创宗门系统
- [ ] 宗门领地争夺
- [ ] 宗门跨服战
- [ ] 宗门历史系统(记录历任掌门)

---

## 💡 游戏提示

### 新手指南
1. **选择合适的宗门**: 根据自己的实力选择合适等级的宗门
2. **积累声望**: 通过完成任务和捐献灵石提升声望
3. **学习功法**: 不同职位可学习不同功法,规划好学习路线
4. **转换策略**: 可以先在低级宗门学习基础功法,再转入高级宗门

### 进阶技巧
1. **声望规划**: 提前规划好要加入的宗门,避免浪费声望
2. **功法收集**: 可以在多个宗门学习功法,打造独特战力
3. **掌门之路**: 长老以上可挑战掌门,获得巨额奖励
4. **经济策略**: 富有玩家可以通过捐献快速提升声望

---

## 📝 实现清单

### 已完成 ✅
- [x] SectService业务逻辑层
- [x] 宗门声望系统
- [x] 职位晋升机制
- [x] 挑战掌门功能
- [x] 宗门商店系统
- [x] 退出保留机制
- [x] Handler层命令
- [x] 系统设计文档

### 待完成 ⏳
- [ ] 宗门任务系统
- [ ] 传功长老NPC
- [ ] 宗门功法配置
- [ ] 宗门建筑升级
- [ ] 宗门成员管理优化

---

**文档版本**: v1.0
**最后更新**: 2025-11-25
**维护者**: Claude Code (Sonnet 4.5)
