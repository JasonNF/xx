# 改名系统说明文档

## 📋 功能概述

修仙游戏中的改名系统允许玩家修改自己的道号（游戏昵称），体现修仙者的身份和个性。

---

## 🎯 核心特性

### 基本规则
- **改名次数**: 终生只能改名**1次**
- **改名费用**: **100,000灵石**（10万灵石）
- **道号长度**: 2-10个字符
- **允许字符**: 中文、英文、数字、·符号

### 限制条件
1. ✅ 每个玩家终生只有一次改名机会
2. ✅ 消耗100,000灵石（不退款）
3. ✅ 道号不能与当前道号相同
4. ✅ 不能包含特殊字符（@#$%等）
5. ✅ 不能以数字开头
6. ✅ 不能包含敏感词或禁用词
7. ✅ 不能为空或只包含空格

---

## 💬 命令使用

### 1. 改名命令

```
/改名 <新道号>
```

**示例**：
```
/改名 逍遥散人
/改名 剑尘真君
/改名 血影魔君
/改名 SwordKing
```

### 2. 查看改名状态

```
/改名状态
```

显示内容：
- 当前道号
- 是否已使用改名机会
- 改名时间（如已改名）
- 当前灵石数量

---

## ✅ 有效道号示例

| 道号 | 说明 |
|------|------|
| 逍遥散人 | 4字中文道号 |
| 剑尘 | 2字道号（最小长度） |
| 青云真君无敌天下 | 10字道号（最大长度） |
| SwordKing | 纯英文道号 |
| 血影魔君123 | 中英文数字混合 |
| 玄天·道人 | 包含·符号 |

---

## ❌ 无效道号示例

| 道号 | 原因 |
|------|------|
| 逍 | 长度不足（<2字符） |
| 这个道号实在太长了超过限制 | 长度超限（>10字符） |
| 123开始 | 以数字开头 |
| 道号@特殊 | 包含特殊字符@ |
| 管理员 | 包含禁用词 |
| 系统道人 | 包含禁用词 |

---

## 🔒 禁用词列表

系统禁止使用以下词汇作为道号的一部分：

- 管理员、GM、系统、官方、客服
- fuck、shit、damn
- 傻逼、操你妈
- 其他敏感词（可根据需要扩展）

---

## 📊 改名流程

```
1. 玩家输入 /改名 <新道号>
   ↓
2. 系统验证道号合法性
   ├─ 检查长度（2-10字符）
   ├─ 检查字符类型（中英文数字·）
   ├─ 检查是否包含禁用词
   └─ 检查是否以数字开头
   ↓
3. 检查玩家改名资格
   ├─ 是否已改过名
   └─ 灵石是否足够（100,000）
   ↓
4. 执行改名
   ├─ 扣除灵石
   ├─ 更新道号
   ├─ 标记已改名
   └─ 记录改名时间
   ↓
5. 显示成功消息
```

---

## 💡 使用建议

### 改名前的考虑

1. **慎重选择**: 终生只有一次机会，请仔细考虑
2. **灵石准备**: 确保有100,000灵石
3. **道号意义**: 选择有意义、有个性的道号
4. **符合角色**: 选择符合自己修仙风格的道号

### 推荐道号风格

- **正道**: 逍遥散人、清风道人、青云真君
- **魔道**: 血影魔君、暗夜魔尊、噬魂老祖
- **剑修**: 剑尘、剑无痕、破天剑圣
- **散修**: 独行客、浪子剑客、流云散人

---

## 🗄️ 数据库结构

### Player表新增字段

```sql
has_renamed BOOLEAN NOT NULL DEFAULT 0  -- 是否已改过名
rename_time DATETIME NULL                -- 改名时间
```

### 迁移脚本

```bash
sqlite3 data/xiuxian.db < data/migrations/add_rename_fields.sql
```

---

## 🧪 测试

运行验证测试：
```bash
python3 tests/test_rename_validation.py
```

测试内容：
- 道号长度验证
- 字符类型验证
- 禁用词检测
- 特殊字符过滤
- 数字开头检测

---

## 📝 示例对话

### 成功改名
```
用户: /改名 逍遥散人

Bot: ✨ 改名成功！

━━━━━━━━━━━━━━━
📜 原道号：张三
🌟 新道号：逍遥散人
💎 消耗灵石：100,000
💰 剩余灵石：50,000
━━━━━━━━━━━━━━━

⚠️ 此为终生唯一改名机会，已使用！

从今日起，修仙界将以 逍遥散人 之名铭记道友！
```

### 已经改过名
```
用户: /改名 另一个名字

Bot: ❌ 改名失败

道友已于 2025年01月15日 改过道号
当前道号：逍遥散人

⚠️ 每人终生只能改名一次，请珍惜机会！
```

### 灵石不足
```
用户: /改名 剑尘真君

Bot: ❌ 灵石不足

改名需要：100,000 灵石
当前拥有：50,000 灵石
还需要：50,000 灵石
```

### 道号无效
```
用户: /改名 管理员

Bot: ❌ 道号包含禁用词：管理员
```

---

## 🔧 技术实现

### 文件结构
```
src/bot/handlers/rename.py           # 改名处理器
src/bot/models/player.py              # Player模型（新增字段）
data/migrations/add_rename_fields.sql # 数据库迁移
tests/test_rename_validation.py      # 验证测试
docs/改名系统说明.md                  # 本文档
```

### 核心函数
- `rename_command()` - 处理改名请求
- `check_rename_status_command()` - 查看改名状态
- `validate_nickname()` - 验证道号合法性

---

## ⚠️ 注意事项

1. **不可逆操作**: 改名后无法撤销或退款
2. **唯一机会**: 终生只能改名一次，请慎重
3. **灵石消耗**: 无论成功与否，测试前请确保充足灵石
4. **命名规范**: 遵守社区规范，文明用语

---

## 🆘 常见问题

**Q: 可以改名多次吗？**
A: 不可以，终生只能改名1次。

**Q: 改名失败会退还灵石吗？**
A: 只有在改名成功后才会扣除灵石，失败不扣费。

**Q: 道号可以包含emoji表情吗？**
A: 不可以，只能包含中文、英文、数字和·符号。

**Q: 如何获得100,000灵石？**
A: 通过修炼、打怪、秘境探索、世界BOSS等途径获取。

**Q: 改名后会影响其他数据吗？**
A: 不会，只会更新道号显示，其他数据不受影响。

---

## 📌 版本历史

- **v1.0** (2025-01-XX) - 初始版本
  - 终生1次改名
  - 消耗100,000灵石
  - 道号长度2-10字符
  - 禁用词过滤
